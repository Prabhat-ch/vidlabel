service: vidlabel # NOTE: update this with your service name

provider:
  name: aws
  runtime: python3.7
  profile: ${file(../config.${self:provider.stage}.json):vidlabel.profile}

  iamRoleStatements:
    - Effect: 'Allow'
      Action:
        - 'rekognition:*'
      Resource: '*'

    - Effect: 'Allow'
      Action:
        - 's3:GetObject'
      Resource:
        Fn::Join:
          - ''
          - - ${self:custom.bucket_arn}
            - '/*'


custom:
  bucket_arn:
    Fn::Join:
      - ":"
      - - arn
        - aws
        - s3
        - ''
        - ''
        - ${file(../config.${self:provider.stage}.json):vidlabel.bucket}


functions:
  process_video:
    handler: handler.process_video
    events:
      - s3:
          bucket: ${file(../config.${self:provider.stage}.json):vidlabel.bucket}
          event: s3:ObjectCreated:*
          rules:
            - suffix: .mp4
